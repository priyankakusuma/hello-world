<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock KPI Dashboard</title>
    {% load static %}
    
    <link href="{% static 'css/style.css' %}" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  
</head>
<body>
    <header>
        <a href="#" class="text-white">Home</a>
        <div class="search-bar-container">
            <input type="text" id="search-bar" placeholder="Search...">
            <button id="create-api-button">Create KPIs</button>
        </div>
        <i class="bi bi-moon-fill toggle-mode text-white"></i>
    </header>
    <div class="content">
        <div class="tickets-container">
            <!-- Tickets Section -->
            <div id="ticket" class="card d-none">
                <div class="card-body">
                    <h5 class="card-title">Current Stock Price</h5>
                    <p id="stock-price">₹0.00</p>
                </div>
            </div>
            <div id="market-cap-ticket" class="card d-none">
                <div class="card-body">
                    <h5 class="card-title">Market Cap</h5>
                    <p id="market-cap-value">₹0</p>
                </div>
            </div>
        </div>
        <div class="results-container">
            <ul id="results"></ul>
        </div>
    </div>
    <script>
        // Dark/Light Mode Toggle
        document.querySelector('.toggle-mode').addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
        });

        // Handle Search Input
        document.getElementById('search-bar').addEventListener('input', function () {
        const searchQuery = this.value.toLowerCase();
        fetch('/fetch-nse-data/')
        .then(response => response.json())
        .then(data => {
        const resultsContainer = document.getElementById('results');
        resultsContainer.innerHTML = '';

        if (data.success) {
        const companies = data.data;
        const filteredCompanies = Object.keys(companies)
        .filter(name => {
        const symbol = companies[name];
        return name.toLowerCase().startsWith(searchQuery) || symbol.toLowerCase().startsWith(searchQuery);
        })
        .map(name => ({
        name: name,
        symbol: companies[name]
        }));

        filteredCompanies.forEach(company => {
        const li = document.createElement('li');
        li.textContent = `${company.name} : ${company.symbol}`;
        li.addEventListener('click', () => {
        document.getElementById('search-bar').value = company.name;
        resultsContainer.style.display = 'none'; // Hide the list
        });
        resultsContainer.appendChild(li);
        });

        if (filteredCompanies.length > 0) {
        resultsContainer.style.display = 'block'; // Show the list if matches found
        } else {
        resultsContainer.style.display = 'none'; // Hide the list if no matches
        }
        } else {
        alert('Failed to fetch data: ' + data.error);
        }
        })
        .catch(error => console.error('Error fetching NSE data:', error));
        });

        // Handle "Create KPI" Button Click
        document.getElementById('create-api-button').addEventListener('click', function () {
        const searchValue = document.getElementById('search-bar').value;

        if (!searchValue) {
        alert('Please select a company from the list.');
        return;
        }

        fetch('/fetch-nse-data/')
        .then(response => response.json())
        .then(data => {
        if (data.success) {
        const companies = data.data;
        const symbol = companies[searchValue];

        if (symbol) {
        fetch(`/fetch-stock-price-inr/?symbol=${symbol}`)
        .then(response => response.json())
        .then(data => {
        const ticket = document.getElementById('ticket');
        ticket.classList.remove('d-none');
        document.getElementById('stock-price').textContent = `₹${data.price.toFixed(2)}`;
        });

        fetch(`/fetch-market-cap/?symbol=${symbol}`)
        .then(response => response.json())
        .then(data => {
        const marketCapTicket = document.getElementById('market-cap-ticket');
        marketCapTicket.classList.remove('d-none');
        document.getElementById('market-cap-value').textContent = `₹${data.market_cap.toLocaleString()}`;
        });
        }
        }
        });
        });
    </script>
</body>
</html>



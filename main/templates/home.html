
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock KPI Dashboard</title>
    {% load static %}

    <link href="{% static 'css/style.css' %}" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</head>
<body data-bs-theme="light">
    <header class="d-flex justify-content-between align-items-center p-3 bg-dark text-white">
        <a href="#" class="text-white">Home</a>
        <div class="d-flex justify-content-center align-items-center w-100">
            <div class="search-bar-container position-relative">
                <input type="text" id="search-bar" placeholder="Search..." class="form-control" autocomplete="off">
                <ul class="dropdown-menu " id="results" style="display: none;"></ul>
                <button id="create-api-button">Create KPIs</button>
            </div>
        </div>
        <i class="bi bi-moon-fill toggle-mode text-white" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Toggle Dark Mode"></i>
    </header>
    <div class="content">

        <div class="tickets-container">
            <div class="tickets-grid">
                <!-- Ticket 1 -->
                <div id="ticket" class="card d-none">
                    <div class="card-body">
                        <h5 class="card-title">Current Stock Price</h5>
                        <p id="stock-price">₹0.00</p>
                    </div>
                </div>
                <!-- Ticket 2 -->
                <div id="market-cap-ticket" class="card d-none">
                    <div class="card-body">
                        <h5 class="card-title">Market Cap</h5>
                        <p id="market-cap-value">₹0</p>
                    </div>
                </div>

                <!-- Ticket 5 -->
                <div id="ticket-cagr-5" class="card d-none">
                    <div class="card-body">
                        <h5 class="card-title">5-Year CAGR</h5>
                        <p id="cagr-5-value">0.00%</p>
                    </div>
                </div>
                <!-- Ticket 6 -->
                <div id="ticket-cagr-3" class="card d-none">
                    <div class="card-body">
                        <h5 class="card-title">3-Year CAGR</h5>
                        <p id="cagr-3-value">0.00%</p>
                    </div>
                </div>
                <!-- Ticket 7 -->
                <div id="volume-trader-ticket" class="card d-none">
                    <div class="card-body">
                        <h5 class="card-title">Volume Traded</h5>
                        <p id="volume-trader-info">Volume: 0</p>
                        <span id="percentage-text" class="percentage-text">0%</span>
                        <!--<div class="progress">
                            <div id="volume-trader-percentage" class="progress-bar bg-success" role="progressbar"
                                 style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                            <span id="percentage-text" class="percentage-text">0%</span>
                        </div>-->
                    </div>
                </div>

                <!-- Ticket 10 -->
                <div id="macd-ticket" class="card d-none">
                    <div class="card-body">
                        <h5 class="card-title">Moving Average Convergence/Divergence (MACD)</h5>
                        <p id="macd-content">Loading...</p>

                    </div>
                   
                </div>
                <!-- Ticket 11 -->
                <div id="rsi-ticket" class="card d-none">
                    <div class="card-body">
                        <h5 class="card-title">Relative Strength Index (RSI)</h5>
                        <p id="rsi-content">Loading...</p>

                    </div>

                    
                </div>
                <!-- Ticket 12 -->
                <div id="bollinger-ticket" class="card d-none">
                    <div class="card-body">
                        <h5 class="card-title">Bollinger Bands</h5>
                        <p id="bollinger-content">Loading...</p>
                        
                    </div>
                </div>
                <!-- Ticket 3 -->
                <div id="ticket-52-week-high" class="card d-none">
                    <div class="card-body">
                        <h5 class="card-title">52-Week High</h5>
                        <p id="high-52-week">₹0.00</p>
                        <p id="high-percentage-diff"></p>
                    </div>
                </div>
                <!-- Ticket 4 -->
                <div id="ticket-52-week-low" class="card d-none">
                    <div class="card-body">
                        <h5 class="card-title">52-Week Low</h5>
                        <p id="low-52-week">₹0.00</p>
                        <p id="low-percentage-diff"></p>
                    </div>
                </div>


                <!--new tickets-->
                <!-- Ticket 5 - Volatility -->
                <div id="volatility-ticket" class="card d-none">
                    <div class="card-body">
                        <h5 class="card-title">Volatility</h5>
                        <p id="volatility-content">Loading...</p>
                    </div>
                </div>

                <!-- Ticket 6 - Dividend Yield -->
                <div id="dividend-yield-ticket" class="card d-none">
                    <div class="card-body">
                        <h5 class="card-title">Dividend Yield</h5>
                        <p id="dividend-yield-content">Loading...</p>
                    </div>
                </div>

                <!-- Ticket 7 - PE Ratio -->
                <div id="pe-ratio-ticket" class="card d-none">
                    <div class="card-body">
                        <h5 class="card-title">PE Ratio</h5>
                        <p id="pe-ratio-content">Loading...</p>
                    </div>
                </div>

                <!-- Ticket 8 - Moving Average (50) -->
                <div id="moving-average-50-ticket" class="card d-none">
                    <div class="card-body">
                        <h5 class="card-title">50-Day Moving Average</h5>
                        <p id="moving-average-50-content">Loading...</p>
                    </div>
                </div>

                <!-- Ticket 9 - Moving Average (200) -->
                <div id="moving-average-200-ticket" class="card d-none">
                    <div class="card-body">
                        <h5 class="card-title">200-Day Moving Average</h5>
                        <p id="moving-average-200-content">Loading...</p>
                    </div>
                </div>



            </div>
        </div>





        <div class="results-container">
            <!--<ul id="results"></ul>-->
        </div>

    </div>
    <script>
    document.addEventListener("DOMContentLoaded", function () {
    const searchBar = document.getElementById("search-bar");
    const resultsDropdown = document.getElementById("results");
    const createKpiButton = document.getElementById("create-api-button");
    const toggleButton = document.querySelector(".toggle-mode");

    const body = document.body;
    toggleButton.addEventListener("click", function () {
    body.classList.toggle("dark-theme");
    });
    let selectedCompany = null;
    
    
    // Function to fetch company names from database or API
    function fetchCompanyNames(query) {
    if (query.length < 1) {
        resultsDropdown.style.display = "none";
        return;
    }

    fetch(`/fetch-nse-data/?query=${query}`)
    .then(response => response.json())
    .then(data => {
        resultsDropdown.innerHTML = "";
        
        if (data.data && data.data.length > 0) {
            // Filter results to show only those starting with the query
            const filteredData = data.data.filter(company =>
                company.name.toLowerCase().startsWith(query.toLowerCase()) ||
                company.symbol.toLowerCase().startsWith(query.toLowerCase())
            );
            
            if (filteredData.length > 0) {
                filteredData.forEach(company => {
                    const listItem = document.createElement("li");
                    listItem.classList.add("dropdown-item");
                    listItem.textContent = `${company.name}:${company.symbol}`;  // Correct display format
                    listItem.dataset.symbol = company.symbol;
                    listItem.dataset.name = company.name;

                    listItem.addEventListener("click", function () {
                        searchBar.value = company.name;  // Use company name for the search bar
                        selectedCompany = company;
                        resultsDropdown.style.display = "none";
                    });

                    resultsDropdown.appendChild(listItem);
                });
                resultsDropdown.style.display = "block";
            } else {
                resultsDropdown.style.display = "none";
            }
        } else {
            resultsDropdown.style.display = "none";
        }
    })
    .catch(error => console.error("Error fetching company data:", error));
    }

    


    // Search event listener
    searchBar.addEventListener("input", function () {
    const query = searchBar.value.trim();
    fetchCompanyNames(query);
    });

    // Hide dropdown if clicked outside
    document.addEventListener("click", function (event) {
    if (!searchBar.contains(event.target) && !resultsDropdown.contains(event.target)) {
    resultsDropdown.style.display = "none";
    }
    });

    // Create KPI button click event
    createKpiButton.addEventListener("click", function () {
    if (!selectedCompany) {
    alert("Please select a company from the dropdown first.");
    return;
    }

    fetch(`/fetch-kpi-data/?symbol=${selectedCompany.symbol}`)
    .then(response => response.json())
    .then(data => {
    document.getElementById("stock-price").textContent = `₹${data.current_stock_price}`;
    document.getElementById("market-cap-value").textContent = `₹${data.market_cap}`;
    document.getElementById("cagr-5-value").textContent = `${data.cagr_5y}%`;
    document.getElementById("cagr-3-value").textContent = `${data.cagr_3y}%`;
    document.getElementById("volume-trader-info").textContent = `Volume: ${data.average_volume_52_week ?? 'N/A'}`;
    // Update the progress bar and percentage
    
    document.getElementById("percentage-text").textContent = `${data.percentage_difference ?? 0}%`;
    document.getElementById("high-52-week").textContent = `₹${data.high_52_week}`;
    document.getElementById("low-52-week").textContent = `₹${data.low_52_week}`;

 

    document.getElementById("high-percentage-diff").textContent = 
    data.high_diff_percentage !== null ? `${data.high_diff_percentage}% far from current price` : 'N/A';
    document.getElementById("low-percentage-diff").textContent = 
    data.low_diff_percentage !== null ? `${data.low_diff_percentage}% far from current price` : 'N/A';
    document.getElementById("volatility-content").textContent = `${data.volatility}%`;
    document.getElementById("dividend-yield-content").textContent = `${data.dividend_yield}%`;
    document.getElementById("pe-ratio-content").textContent = `${data.pe_ratio}`;
    document.getElementById("moving-average-50-content").textContent = `₹${data.moving_average_50 || 'N/A'}`;
    document.getElementById("moving-average-200-content").textContent = `₹${data.moving_average_200 || 'N/A'}`; // handle null or undefined
    document.getElementById("macd-content").textContent = `MACD: ${data.macd ?? 'N/A'}, Signal: ${data.macd_signal ?? 'N/A'}`; 
    document.getElementById("rsi-content").textContent = `${data.rsi ?? 'N/A'}`;
    document.getElementById("bollinger-content").textContent = `${data.bollinger ?? 'N/A'}`;

    // Show all cards
    document.querySelectorAll(".card").forEach(card => card.classList.remove("d-none"));
    })
    .catch(error => console.error("Error fetching KPI data:", error));
    });
    });
    </script>

   
</body>
</html>






